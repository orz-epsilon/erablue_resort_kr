
@ダンジョン初期処理_困りごと解決
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
;
#DIM 深度
#DIM 分岐
#DIMS 接続先配列,2

VARSET ダンジョン構造配列_困りごと解決
VARSET 分割ブロックリスト
VARSET ランダムダンジョン配列
ランダムダンジョン中フラグ = 1
; CALL ブロック生成(8)
; CALL ブロック内部屋生成(20)
CALL 穴掘り方式()
CALL 部屋タイプ割り当て_困りごと解決


ダンジョンサブタイトル = CONVENIENCE AGENCY
ダンジョンマス画像URL_伏せ状態 = 壁_街
ダンジョン現在位置:0 = ランダムダンジョン初期位置:0
ダンジョン現在位置:1 = ランダムダンジョン初期位置:1
ダンジョン背景画像 = 背景_街

;スタート地点は必ず存在
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：そこから通路を伸ばすか　ビット3：入れないが表示する場合に使用
;ビット4以降：自由枠フラグ

IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{ランダムダンジョン初期位置:0}:{ランダムダンジョン初期位置:1}") == 0
	SETVAR @"ダンジョン構造配列_%ダンジョン名%:{ランダムダンジョン初期位置:0}:{ランダムダンジョン初期位置:1}", 3
ENDIF


FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF ダンジョン構造配列_困りごと解決:深度:分岐
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_困りごと解決_{深度}_{分岐}")
			LOCAL = 1
			ダンジョン構造配列_困りごと解決:深度:分岐 = 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョン解説文_困りごと解決

詳細文文字列受け渡し変数 = 
詳細文文字列受け渡し変数 += "리조트 섬을 돌아다니며, 사소한 문제들을 해결한다. <br>"
詳細文文字列受け渡し変数 += "업무의 일환이므로 해결해도 루피는 받을 수 없지만, <br>"
詳細文文字列受け渡し変数 += "그 대신 답례로 다양한 선물을 받을 수 있을 것이다. <br>"
詳細文文字列受け渡し変数 += "들어갈 때마다 구조가 변화한다. <br>"

ランダムダンジョンフラグ = 1

;推奨レベルを返す
RETURN 5

@敵討伐後処理_ダンジョン固有_困りごと解決(討伐エネミー数)
;ダンジョン内で戦闘した後に呼ばれる関数、主にダンジョンごとのドロップアイテム取得に使用
;まだ敵データはリセットしていないので敵BATTLE_STATEで色々情報は取得可能
#DIM 討伐エネミー数
#DIM ドロップ確率
#DIMS ドロップアイテム

ドロップ確率 = 20 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 3)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 15 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 3)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 10 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 3)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 5 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 3)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 20 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 2)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 15 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 2)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 10 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 2)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 5 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 2)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 5 * 討伐エネミー数
ドロップアイテム = %ランダム素材名("贈答アイテム", 2)%
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 5 * 討伐エネミー数
ドロップアイテム = 古ぼけた指輪・銅
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 5 * 討伐エネミー数
ドロップアイテム = 古ぼけた耳飾り・銅
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 1 * 討伐エネミー数 / 2
ドロップアイテム = 古ぼけた指輪・銀
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

ドロップ確率 = 1 * 討伐エネミー数 / 2
ドロップアイテム = 古ぼけた耳飾り・銀
CALL ドロップ判定処理(ドロップ確率, ドロップアイテム)

;----------
;部屋の内容を割り当てる
;----------
@部屋タイプ割り当て_困りごと解決
#DIM キャライベ数
#DIM 対象キャラ
;部屋の属性を調べて対応する条件の部屋からランダムに割り当てる
;ランダムダンジョン配列:深度:分岐:イベント名 = イベントの名前
#DIM 深度
#DIM 分岐

;固有イベントをチェック
VARSET RESULTS
VARSET LOCALS
LOCAL:1 = 0
キャライベ数 = ENUMFUNCBEGINSWITH("イベント_困りごと解決_キャラ依頼_")
FOR LOCAL, 0, キャライベ数
	;依頼のキャラを引っ張ってくる
	対象キャラ = TOINT(SUBSTRING(RESULTS:LOCAL, 33))
	SIF 対象キャラ < 1
		CONTINUE
	;キャラが島にいないとダメ
	SIF CFLAG:対象キャラ:滞在期間 < 0
		CONTINUE
	;ある程度仲良くないとダメ
	SIF CFLAG:対象キャラ:好感度レベル < 関係閾値:2
		CONTINUE
	;キャラがPTメンバーにいるとダメ
	SIF GROUPMATCH(対象キャラ, BATTLE_STATE:0:キャラ登録番号, BATTLE_STATE:1:キャラ登録番号, BATTLE_STATE:2:キャラ登録番号, BATTLE_STATE:3:キャラ登録番号, BATTLE_STATE:10:キャラ登録番号, BATTLE_STATE:11:キャラ登録番号, BATTLE_STATE:12:キャラ登録番号, BATTLE_STATE:13:キャラ登録番号)
		CONTINUE
	LOCALS:(LOCAL:1) = %RESULTS:LOCAL%
	LOCAL:1 += 1
NEXT
キャライベ数 = LOCAL:1

FOR 深度, 0, 10
	FOR 分岐, 0, 10
		SIF ランダムダンジョン配列:深度:分岐:イベント状態 == ""
			CONTINUE
		IF 深度 == ランダムダンジョン初期位置:0 && 分岐 == ランダムダンジョン初期位置:1
			;初期位置
			ランダムダンジョン配列:深度:分岐:イベント名 = 初期マス
		ELSE
			;イベントがあるのは半分のマス
			IF RAND:2
				ランダムダンジョン配列:深度:分岐:イベント名 = 何もなし
				CONTINUE
			ENDIF
			;更に1/2でキャライベを格納
			IF キャライベ数 > 0 && RAND:2
				LOCAL = RAND:キャライベ数
				ランダムダンジョン配列:深度:分岐:イベント名 = %SUBSTRING(LOCALS:LOCAL, 22)%
				ランダムダンジョン配列:深度:分岐:マス画像名 = 依頼
				ARRAYSHIFT LOCALS, -1, "", LOCAL
				キャライベ数 -= 1
				CONTINUE
			ENDIF
			;残りは汎用イベ
			SELECTCASE RAND:6
				CASE 5
					ランダムダンジョン配列:深度:分岐:イベント名 = 疲れたおじいさん
				CASE 4
					ランダムダンジョン配列:深度:分岐:イベント名 = 遊戯場修理
				CASE 3
					ランダムダンジョン配列:深度:分岐:イベント名 = ナンパに困る女性
				CASE 2
					ランダムダンジョン配列:深度:分岐:イベント名 = 忘れっぽい青年
				CASE 1
					ランダムダンジョン配列:深度:分岐:イベント名 = 迷子の男の子
				CASE 0
					ランダムダンジョン配列:深度:分岐:イベント名 = ペット探し
			ENDSELECT
			ランダムダンジョン配列:深度:分岐:マス画像名 = 依頼
		ENDIF
	NEXT
NEXT


;----------
;マスタイプ
;----------
@マスタイプ_困りごと解決(深度,分岐)
#DIM 深度
#DIM 分岐
SELECTCASE ランダムダンジョン配列:深度:分岐:マス画像名
	;マスタイプで分岐
	CASE IS == "依頼"
		ダンジョンマス画像URL = 床_街
		IF ランダムダンジョン配列:深度:分岐:イベント状態 != "依頼完了"
			ダンジョンマス画像URL_重ね表示 = 会話アイコン
		ENDIF
	CASE IS == ""
		ダンジョンマス画像URL = 床_街
	CASEELSE
		ダンジョンマス画像URL = 床_街
ENDSELECT



;----------
;イベント内容
;----------
@イベント_困りごと解決_初期マス
ダンジョンクリアフラグ_困りごと解決 = 1
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 주변을 돌아다니며 문제들을 해결해 나가자.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	KSTR:(K++) = 사람이 살고 있다면, 여러 가지 문제들이 발생한다.
	KSTR:(K++) = 주변을 돌아다니며 해결해 나가자.
	CALL メッセージ欄表示用関数()
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_何もなし
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	KSTR:(K++) = 다른 장소를 돌아다녀 보자.
	CALL メッセージ欄表示用関数()
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_ペット探し
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	WSTR:(K++) = 소녀가 반쯤 울면서 무언가의 이름을 부르고 있다.
	WSTR:(K++) = 아무래도 데려온 펫이 길을 잃은 것 같다.
	KSTR:(K++) = 함께 찾아주자. _PAGE
	WSTR:(K++) = …
	WSTR:(K++) = ……
	WSTR:(K++) = ………찾았다!
	LOCALS = %ランダム素材名("贈答アイテム", 1)%
	WSTR:(K++) = 목줄을 단 고양이를 소녀에게 돌려주자, 소녀는 답례로 「%LOCALS%」을(를) 주었다.
	KSTR:(K++) = %CALLNAME:PLAYER%들은 기쁜 듯 웃는 소녀와 헤어져, 다른 곤란한 일을 찾아 나선다.
	CALL メッセージ欄表示用関数()
	CALL 素材入手処理(LOCALS, 1)
	ランダムダンジョン配列:(ダンジョン現在位置:0):(ダンジョン現在位置:1):イベント状態 = 依頼完了
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_迷子の男の子
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	WSTR:(K++) = 작은 남자아이가 혼자서 두리번거리며 주위를 둘러보고 있다.
	WSTR:(K++) = 아무래도 부모와 헤어진 미아인 것 같다.
	KSTR:(K++) = 함께 가족을 찾아주자._PAGE
	WSTR:(K++) = …
	WSTR:(K++) = ……
	WSTR:(K++) = ………찾았다!
	LOCALS = %ランダム素材名("贈答アイテム", 1)%
	WSTR:(K++) = 어머니에게 미아 남자아이를 데려오자, 어머니는 답례로 「%LOCALS%」을(를) 주었다.
	KSTR:(K++) = %CALLNAME:PLAYER%들은 어머니에게 어리광 부리는 남자아이와 헤어져, 다른 곤란한 일을 찾아 나선다.
	CALL メッセージ欄表示用関数()
	CALL 素材入手処理(LOCALS, 1)
	ランダムダンジョン配列:(ダンジョン現在位置:0):(ダンジョン現在位置:1):イベント状態 = 依頼完了
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_忘れっぽい青年
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	WSTR:(K++) = 청년이 수영장 앞에서 곤란해하고 있다.
	WSTR:(K++) = 아무래도 수영하며 놀 생각이었는데 수영복을 잊어버린 것 같다.
	LOCALS = %ランダム素材名("贈答アイテム", 2)%
	WSTR:(K++) = 수영복 대여 창구까지 데려가자, 청년은 기뻐하며 답례로 「%LOCALS%」을(를) 주었다.
	KSTR:(K++) = %CALLNAME:PLAYER%들은 놀자며 기합을 넣는 청년과 헤어져, 다른 곤란한 일을 찾아 나선다.
	CALL メッセージ欄表示用関数()
	CALL 素材入手処理(LOCALS, 1)
	ランダムダンジョン配列:(ダンジョン現在位置:0):(ダンジョン現在位置:1):イベント状態 = 依頼完了
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_ナンパに困る女性
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
WSTR:(K++) = 젊은 여성이 남성 2명에게 말을 걸고 있다.
	WSTR:(K++) = 아무래도 헌팅을 잘 거절하지 못해 곤란해하는 것 같다.
	KSTR:(K++) = %CALLNAME:PLAYER%은(는) 사이에 끼어들어, 리조트 관리인으로서 강요하지 말라고 주의를 주었다._PAGE
	WSTR:(K++) = 남성들은 곤란하게 할 생각은 없었다고 사과하며, 여성에게서 멀어져 간다.
	LOCALS = %ランダム素材名("贈答アイテム", 2)%
	WSTR:(K++) = 여성은 정중하게 %CALLNAME:PLAYER%에게 고개를 숙이며, 답례로 「%LOCALS%」을(를) 주었다.
	KSTR:(K++) = %CALLNAME:PLAYER%들은 안심하고 리조트에서 노는 여성과 헤어져, 다른 곤란한 일을 찾아 나선다.
	CALL メッセージ欄表示用関数()
	CALL 素材入手処理(LOCALS, 1)
	ランダムダンジョン配列:(ダンジョン現在位置:0):(ダンジョン現在位置:1):イベント状態 = 依頼完了
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_遊戯場修理
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	WSTR:(K++) = 오락실에 들어가자, 두 남성이 망연자실해 있었다.
	WSTR:(K++) = 아무래도 의도치 않게, 오락실 설비를 부숴버린 것 같다.
	KSTR:(K++) = 조금 살펴보았지만, 이 정도 손상이라면 부품을 교체하면 고쳐질 것이다._PAGE
	IF RAND:2
		LOCALS = 낡은 반지・구리
	ELSE
		LOCALS = %ランダム素材名("贈答アイテム", 3)%
	ENDIF
	WSTR:(K++) = %CALLNAME:PLAYER%이(가) 재빨리 설비를 고치자, 남성들은 안도한 모습으로 답례로 「%LOCALS%」을(를) 주었다.
	KSTR:(K++) = %CALLNAME:PLAYER%들은 부수지 않도록 조심스럽게 설비를 다루는 남성들과 헤어져, 다른 곤란한 일을 찾아 나선다.
	CALL メッセージ欄表示用関数()
	CALL 素材入手処理(LOCALS, 1)
	ランダムダンジョン配列:(ダンジョン現在位置:0):(ダンジョン現在位置:1):イベント状態 = 依頼完了
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

@イベント_困りごと解決_疲れたおじいさん
CALL 口上変数初期化
IF 初来訪マス判定用フラグ == 0
	KSTR:(K++) = 이 근처에는 곤란해하는 사람이 없는 것 같다.
	CALL メッセージ欄表示用関数(,,,0)
ELSE
	;最初に訪れた時
	IF 施設改造度:3:0
		WSTR:(K++) = 캠핑장에 가자, 나무 그늘에 할아버지가 주저앉아 있었다.
	ELSE
		WSTR:(K++) = 리조트 하우스의 정원에 가자, 나무 그늘에서 할아버지가 주저앉아 있었다.
	ENDIF
	WSTR:(K++) = 아무래도 산책하는 동안 기분이 나빠진 것 같았다.
	KSTR:(K++) = %CALLNAME:PLAYER%는 물을 건네고, 수건으로 할아버지의 땀을 닦는다…._PAGE
	IF RAND:2
		LOCALS = 낡은 귀걸이・동
	ELSE
		LOCALS = %ランダム素材名("贈答アイテム", 3)%
	ENDIF
	WSTR:(K++) = 잠시 후 기분이 좋아진 듯, 할아버지는 몇 번이고 감사를 표하며 「%LOCALS%」를 주었다.
	KSTR:(K++) = %CALLNAME:PLAYER%들은 몸조심하라고 할아버지를 걱정하며, 다른 곤란한 일을 찾아 나선다.
	CALL メッセージ欄表示用関数()
	CALL 素材入手処理(LOCALS, 1)
	ランダムダンジョン配列:(ダンジョン現在位置:0):(ダンジョン現在位置:1):イベント状態 = 依頼完了
	CALL 接続ルート全開放処理((ダンジョン現在位置:0), (ダンジョン現在位置:1))
	CALL 口上変数初期化
ENDIF
CALL 画面再描画

